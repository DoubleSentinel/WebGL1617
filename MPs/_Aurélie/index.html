<!DOCTYPE HTML>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Calcul matriciel</title>
    <link rel="stylesheet" href="../css/stylesheet.css">
		<!-- import of webgl utilities -->
    <script src="../sharedJs/commonFunctions.js"></script>
    <script src="../sharedJs/gl-matrix-min.js"></script>
    <script src="../sharedJs/webglTools.js"></script>
		<script src="debug/webgl-debug.js"></script>
		<!-- import application scripts -->
    <script src="./js/matrix.js"></script>

    <!-- vertex shader -->
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
  			attribute vec4 aColor;
  			uniform mat4 uMVMatrix;
  			uniform mat4 uPMatrix;
  			varying vec4 vColor;
  			void main(void) {
  				vColor = aColor;
  				gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
  			}
    </script>
    <!-- fragment shader -->
    <script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
				precision highp float;
			#endif
				varying vec4 vColor;
				void main(void) {
				  gl_FragColor = vColor;
				}
    </script>
    <!--WebGL logique-->
    <script>
    //créer un canevas mais ne l'ajoute pas dans le DOM. Pour computational use
    //From : http://www.vizitsolutions.com/portfolio/webgl/gpgpu/implementation.html (07.12.16)
      /*function makeGPCanevas(width,height){
        var canvas;
        canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        canvas.id = 'webgl-canvas'
      }*/
      //From: ch10ex1b
      var vertexBuffer = null;
      var indexBuffer = null;
      var textCoordsBuffer = null;
      var texColorTab = new Array();
      var indices = [];
      var vertices = [];
      var textCoords =[];
      var mvMatrix = mat4.create();
      var pMatrix = mat4.create();
      var textureSize = 1024;
      //From: ch10ex1b
      function initShaderParameters(prg){
        prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
        glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
        prg.textureCoordsAttribute  = glContext.getAttribLocation(prg, "aTextureCoord");
        glContext.enableVertexAttribArray(prg.textureCoordsAttribute);
        prg.pMatrixUniform          = glContext.getUniformLocation(prg, 'uPMatrix');
        prg.mvMatrixUniform         = glContext.getUniformLocation(prg, 'uMVMatrix');
        prg.modeUniform 		    = glContext.getUniformLocation(prg, "uMode");
        prg.uColorTexture 			= glContext.getUniformLocation(prg, "uColorTexture");
      }

      function initWebGL(){
      //  makeGPCanevas(128,128);//La taille du canevas correspond à la taille des textures
        glContext = getGLContext('webgl-canvas');
        console.log("glContext "+glContext);
      }
    </script>
</head>
<body onload="initWebGL()">
  <h2>Entrer un fichier JSON contenant une matrice</h2>
  <input type="file" id="fileJson" name="files[]" accept=".json"/>
  <h3>Voici les deux matrices entrées</h3>
  <h4>Matrice A</h4>
  <table id="matrixATable">
  </table>
  <h4>Matrice B</h4>
  <table id="matrixBTable">
  </table>
  <br/>
  <h2>Résultat</h2>
  <table id="resultTable">
  </table>
  <canvas id="webgl-canvas" width="128" height="128" style="display:none">
  </canvas>
  <script>
  document.getElementById("fileJson").addEventListener("change",changeFileJson,false);
    //Récupération du fichier.
    function changeFileJson(evt){
      var file = evt.target.files[0];
      var fileJson = evt.target;
      var reader = new FileReader();
      reader.onload = function(){
        var text = reader.result;
        var parseText = JSON.parse(text);
        createMatrix(parseText);
      };
      reader.readAsText(fileJson.files[0]);
      //console.log("Fichier lu");
    }
    //Create matrix with the JSON file given
    function createMatrix(textJson){
      if(textJson == undefined || textJson.n == undefined || textJson.A == undefined || textJson.B == undefined){
        alert("Le fichier contenant la matrice comporte une erreur");
      }
      else{
        dimension = textJson.n;
        matrixA = new Matrix(dimension);
        matrixB = new Matrix(dimension);
        //Remplissage des matrices
        var size = Math.pow(dimension,2);
        var rowA = 0, rowB =0, colA = 0, colB=0;
        for(var i=0; i<size; i++){
          matrixA.put(rowA, colA++, textJson.A[i]);
          matrixB.put(rowB, colB++, textJson.B[i]);
          if((i+1)%dimension == 0){
            colA = 0;
            colB=0;
            rowA++;
            rowB++;
          }
        }
        console.log("Matrices construites");
        matrixA.display('matrixATable');
        console.log("matrixB");
        matrixB.display('matrixBTable');
        console.log("Matrices affichées");
      }
    }
    //Clear the table
    function clearTable(tableID){
      var table = document.getElementById(tableID);
      var row = table.rows.lenght;
      while(row--){
        table.deleteRow(row);
      }
    }

  </script>
</body>
</html>
