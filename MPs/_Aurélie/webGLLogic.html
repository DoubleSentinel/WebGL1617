<script>
var vertexBuffer = null;
var indexBuffer = null;
var textCoordsBuffer = null;
var texColorTab = new Array();
var indices = [];
var vertices = [];
var textCoords =[];
var mvMatrix = mat4.create();
var pMatrix = mat4.create();
var textureSize = 1024;
function initShaderParameters(prg){
  prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
  glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
  prg.textureCoordsAttribute  = glContext.getAttribLocation(prg, "aTextureCoord");
  glContext.enableVertexAttribArray(prg.textureCoordsAttribute);
  prg.pMatrixUniform          = glContext.getUniformLocation(prg, 'uPMatrix');
  prg.mvMatrixUniform         = glContext.getUniformLocation(prg, 'uMVMatrix');
  prg.modeUniform 		    = glContext.getUniformLocation(prg, "uMode");
  prg.uColorTexture 			= glContext.getUniformLocation(prg, "uColorTexture");
}
function initBuffers(){
  vertices = [ -1.2, -1.0, 0.0,
          1.2, -1.0, 0.0,
         -1.2,  1.0, 0.0,
          1.2,  1.0, 0.0 ];
  indices = [ 0, 1, 2, 3 ];
  textCoords = [  0.0, 0.0,
          1.0, 0.0,
          0.0, 1.0,
          1.0, 1.0 ];
  vertexBuffer     = getArrayBufferWithArray(vertices);
  indexBuffer      = getIndexBufferWithIndices(indices);
  textCoordsBuffer = getArrayBufferWithArray(textCoords);
}
var TEXTURE_RENDERING_MODE = 1;
var SCREEN_RENDERING_MODE = 0;
var renderPasses = 0;
var currentTextureIndx;
var rttFramebuffer = new Array();
var rttTexture = new Array();
function initTextureFramebuffer(index) {
  rttFramebuffer[index] = glContext.createFramebuffer();
  glContext.bindFramebuffer(glContext.FRAMEBUFFER, rttFramebuffer[index]);
  rttFramebuffer[index].width = textureSize;
  rttFramebuffer[index].height = textureSize;
  rttTexture[index] = glContext.createTexture();
  glContext.bindTexture(glContext.TEXTURE_2D, rttTexture[index]);
  glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MIN_FILTER, glContext.NEAREST);
  glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MAG_FILTER, glContext.NEAREST);
  glContext.texImage2D(glContext.TEXTURE_2D, 0, glContext.RGBA, rttFramebuffer[index].width,
  rttFramebuffer[index].height, 0, glContext.RGBA, glContext.UNSIGNED_BYTE, null);
  var renderbuffer = glContext.createRenderbuffer();
  glContext.bindRenderbuffer(glContext.RENDERBUFFER, renderbuffer);
  glContext.renderbufferStorage(glContext.RENDERBUFFER, glContext.DEPTH_COMPONENT16,
  rttFramebuffer[index].width, rttFramebuffer[index].height);
  glContext.framebufferTexture2D(glContext.FRAMEBUFFER, glContext.COLOR_ATTACHMENT0,
  glContext.TEXTURE_2D, rttTexture[index], 0);
  glContext.framebufferRenderbuffer(glContext.FRAMEBUFFER, glContext.DEPTH_ATTACHMENT,
  glContext.RENDERBUFFER, renderbuffer);
  glContext.bindTexture(glContext.TEXTURE_2D, null);
  glContext.bindRenderbuffer(glContext.RENDERBUFFER, null);
  glContext.bindFramebuffer(glContext.FRAMEBUFFER, null);
  }
function glContextCommonBindInfo(){
  glContext.bindBuffer(glContext.ARRAY_BUFFER, vertexBuffer);
  glContext.vertexAttribPointer(prg.vertexPositionAttribute, 3, glContext.FLOAT, false, 0, 0);
  glContext.bindBuffer(glContext.ARRAY_BUFFER, textCoordsBuffer);
  glContext.vertexAttribPointer(prg.textureCoordsAttribute, 2, glContext.FLOAT, false, 0, 0);
  glContext.bindBuffer(glContext.ELEMENT_ARRAY_BUFFER, indexBuffer);
  }
function identityMatrices() {
  mat4.identity(pMatrix);
  glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
  mat4.identity(mvMatrix);
  rotateModelViewMatrixUsingQuaternion(true);
  glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvMatrix);
}
function clearBkGd(){
  glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
  glContext.clearColor(0.9, 0.9, 1.0, 1.0);
}
  function renderATextureInTexture(index){
    glContext.viewport(0, 0, rttFramebuffer[index].width, rttFramebuffer[index].height);
    clearBkGd();
    if (renderPasses<4){
      glContext.bindTexture(glContext.TEXTURE_2D, texColorTab[0]);
      renderPasses++;
    }else{
      glContext.bindTexture(glContext.TEXTURE_2D, rttTexture[index == 0 ? 1 : 0]);
    }
    identityMatrices();
    glContextCommonBindInfo();
    glContext.uniform1i(prg.modeUniform, TEXTURE_RENDERING_MODE);
    glContext.activeTexture(glContext.TEXTURE0);
    glContext.drawElements(glContext.TRIANGLE_STRIP, indices.length, glContext.UNSIGNED_SHORT, 0);
  }

function renderOnTheScreenWithoutPerspective(){
  glContext.viewport( 0.0, 0.0, c_width, c_height);
  glContext.enable(glContext.DEPTH_TEST);
  clearBkGd();
  identityMatrices();
  glContextCommonBindInfo();
  glContext.uniform1i(prg.modeUniform, SCREEN_RENDERING_MODE);
  glContext.activeTexture(glContext.TEXTURE0);
  glContext.bindTexture(glContext.TEXTURE_2D, rttTexture[currentTextureIndx]);
  glContext.drawElements(glContext.TRIANGLE_STRIP, indices.length, glContext.UNSIGNED_SHORT, 0);
}

function initWebGL(){
  glContext = getGLContext('webgl-canvas');
  initProgram();
  initBuffers();
  initTextureWithImage( "fig/tree_512x512.png", texColorTab );
  initTextureFramebuffer(0);
  initTextureFramebuffer(1);
  currentTextureIndx = 0;
  renderLoop();
}
</script>
